> **重要声明**
>
> 本插件基于 [shskjw](https://github.com/shskjw) 大佬的开源项目 [astrbot_plugin_shoubanhua](https://github.com/shskjw/astrbot_plugin_shoubanhua) 进行了深度的二次开发和功能扩展。
>
> ---
# 智能AI绘图助手 (astrbot_plugin_image_generator)

版本: 1.1.2

一款功能强大的AI绘图插件，支持多种API提供商（包括但不限于柏图API、NewAPI、自搭建API等），集成了智能统一指令及后台管理功能。

## ✨ 核心功能

- **智能统一指令**: 使用 `/生图` 指令，插件会自动检测你是否发送了图片，智能切换【文生图】和【图生图】模式。
- **强大的管理功能**: 管理员可以通过指令轻松管理API Key、增减用户和群组的使用次数。
- **灵活的次数控制**: 支持分别或同时开启个人和群组的使用次数限制。
- **多API Key轮换与重试**: 可配置多个API Key，插件会在请求失败时自动切换，提高可用性。
- **自动清理**: 卸载插件时，会自动删除所有相关的缓存和数据文件，保持系统清洁。
- **可选的图片保存**: 可以配置是否将生成的图片保存到本地，默认情况下图片会在发送给用户后自动删除。

## ⚙️ 安装与配置

### 安装

1. 下载本插件，将 `astrbot_plugin_image_generator` 整个文件夹放入您的 AstrBot 插件目录 (`/plugins`) 中。
2. 重启 AstrBot。

### 配置

在 AstrBot 管理面板的 `插件管理` -> `AI 生图` 中进行配置。核心配置项包括API地址、密钥、代理设置和次数限制等。

#### 支持的API提供商

本插件支持多种API提供商，只需正确配置API地址和模型名称即可使用：

> **注意**: API地址通常需要包含特定的后缀路径，如 `/v1/chat/completions` 或 `/v1/images/generations`。如果您不确定应该使用哪个后缀，请咨询您的API提供商。

##### API认证方式

插件会自动识别并选择合适的API认证方式，无需手动配置：

- 对于标准的API密钥（如以 `sk-` 开头或不含空格的密钥），插件会自动添加 `Bearer ` 前缀
- 对于自定义格式的密钥（如包含空格或其他特殊字符），插件会直接使用密钥作为认证头
- 如果未提供密钥，则不添加认证头

##### 1. 柏图API（默认配置）
- **API地址**: `https://api.bltcy.ai/v1/chat/completions`
- **模型名称**: 如 `gemini-2.5-flash-image` 等
- **API密钥**: 从柏图平台获取的API密钥

##### 2. NewAPI
- **API地址**: 根据NewAPI提供的地址填写（通常包含 `/v1/chat/completions` 后缀）
- **模型名称**: 根据NewAPI支持的模型填写
- **API密钥**: 从NewAPI平台获取的API密钥

##### 3. 自搭建API（如基于ComfyUI、Stable Diffusion等）
- **API地址**: 您自搭建服务的API地址，例如 `http://your-server-ip:port/v1/chat/completions`
- **模型名称**: 根据您部署的模型填写
- **API密钥**: 如果有认证要求，则填写相应密钥，否则可为空

##### 4. 其他兼容OpenAI格式的API提供商
- **API地址**: 提供商的API地址（通常需要包含 `/v1/chat/completions` 或类似后缀）
- **模型名称**: 提供商支持的模型名称
- **API密钥**: 从对应平台获取的API密钥

#### 图片保存配置

- **save_images_locally**: 是否保存生成的图片到本地，默认为关闭。开启后，生成的图片将保存到插件数据目录，文件名为 `generated_时间戳.png`。关闭后，图片会在发送给用户后自动删除。

## 📝 更新日志

- 1.1.2
  - 内置 `/生图帮助` 文案，移除面板自定义项
  - 帮助输出改为纯文本，移除字体与图片渲染依赖
  - 支持 `text/event-stream` 流式响应解析，自动提取图片
  - 未开启任何次数限制时，仅发送图片、不附加成功说明文本
  - 请求头补充 `Accept: application/json`，提升兼容性

---

## 📖 命令列表

`/生图帮助` 命令会以文本形式展示以下所有指令：

### ⭐ 智能指令 (推荐)

| 命令 | 功能说明 |
| :--- | :--- |
| `/生图` | `<提示词> [图片]` - 自动判断文生图/图生图模式。 |



### 🔧 通用指令

| 命令 | 功能说明 |
| :--- | :--- |
| `/生图帮助` | 显示帮助文本 |
| `/生图查询次数` | 查询个人和所在群的剩余次数 |

### 🔑 管理指令 (仅主人)

| 命令 | 功能说明 |
| :--- | :--- |
| `/生图添加key` | `<key1> ...` - 批量添加API密钥 |
| `/生图key列表` | 查看所有密钥 |
| `/生图删除key` | `<序号\|all>` - 删除指定或全部密钥 |
| `/生图增加用户次数` | `<QQ号> <数量>` - 增加用户次数 |
| `/生图增加群组次数` | `<群号> <数量>` - 增加群聊次数 |
